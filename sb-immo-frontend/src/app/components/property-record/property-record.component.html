<div class="property-record-container">
  <div class="title-container">
    <button pButton label="New property record" (click)="openDialog()"></button>

    <app-create-property-record
      [visible]="openCreateDialog"
      (closeDialog)="openCreateDialog = false"
    ></app-create-property-record>
  </div>

  <div class="table-container">
    <p-table
      [value]="(propertyRecords$ | async) ?? []"
      dataKey="contactId"
      [rows]="10"
      editMode="row"
      [rowsPerPageOptions]="[5, 10, 20]"
      [loading]="loading"
      [paginator]="true"
      [globalFilterFields]="[
        'firstname',
        'lastname',
        'email',
        'phone',
        'notes'
      ]"
      [tableStyle]="{ width: '100%' }"
    >
      <ng-template #header>
        <tr>
          <th>Avatar</th>
          <th>Property</th>
          <th>Contact</th>
          <th>Role</th>
          <th>StartAt</th>
          <th>EndAt</th>
          <th>Notes</th>
          <th>Edit</th>
        </tr>
        <tr>
          <th></th>
          <!--- TODO -->
          <th>
            <p-columnFilter
              field="propertyId"
              type="text"
              placeholder="Search by property name or street"
            ></p-columnFilter>
          </th>
          <th>
            <p-columnFilter
              field="contactId"
              type="text"
              placeholder="Search by contact"
            ></p-columnFilter>
          </th>
          <th>
            <p-columnFilter
              field="role"
              type="text"
              placeholder="Search by role"
            ></p-columnFilter>
          </th>
          <th>
            <p-columnFilter
              field="startAt"
              type="text"
              placeholder="Search by startAt"
            ></p-columnFilter>
          </th>
          <th>
            <p-columnFilter
              field="endAt"
              type="text"
              placeholder="Search by endAt"
            ></p-columnFilter>
          </th>
          <th>
            <p-columnFilter
              field="notes"
              type="text"
              placeholder="Search by notes"
            ></p-columnFilter>
          </th>
          <th></th>
        </tr>
      </ng-template>

      <ng-template
        #body
        let-propertyRecord
        let-editing="editing"
        let-ri="rowIndex"
      >
        <tr [pEditableRow]="propertyRecord">
          <td>
            <p-avatar icon="pi pi-home" class="mr-2" />
          </td>
          <td>
            <p-cellEditor>
              <ng-template #input>
                <!-- <input pInputText type="text" [(ngModel)]="propertyRecord.propertyId" /> -->
                <app-search-property />
              </ng-template>
              <ng-template #output>
                {{ propertyRecord.propertyId }}
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <p-cellEditor>
              <ng-template #input>
                <!-- <input pInputText type="text" [(ngModel)]="propertyRecord.propertyId" /> -->
                <app-search-contacts />
              </ng-template>
              <ng-template #output>
                {{ propertyRecord.contactId }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template #input>
                <app-basis-combos [suggestions]="statuses" />
              </ng-template>
              <ng-template #output>
                <p-tag
                  [value]="getStatusTag(propertyRecord.role).label"
                  [severity]="getStatusTag(propertyRecord.role).severity"
                />
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template #input>
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="propertyRecord.startAt"
                />
              </ng-template>
              <ng-template #output>
                {{ propertyRecord.startAt }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template #input>
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="propertyRecord.endAt"
                />
              </ng-template>
              <ng-template #output>
                {{ propertyRecord.endAt }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template #input>
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="propertyRecord.notes"
                />
              </ng-template>
              <ng-template #output>
                {{ propertyRecord.notes }}
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <div class="flex items-center justify-center gap-2">
              <button
                *ngIf="!editing"
                pButton
                pRipple
                type="button"
                pInitEditableRow
                icon="pi pi-pencil"
                (click)="onRowEditInit()"
                text
                rounded
                severity="secondary"
              ></button>
              <button
                *ngIf="editing"
                pButton
                pRipple
                type="button"
                pSaveEditableRow
                icon="pi pi-check"
                (click)="onRowEditSave(propertyRecord)"
                text
                rounded
                severity="secondary"
              ></button>
              <button
                *ngIf="editing"
                pButton
                pRipple
                type="button"
                pCancelEditableRow
                icon="pi pi-times"
                (click)="onRowEditCancel()"
                text
                rounded
                severity="secondary"
              ></button>
            </div>
          </td>
          <!-- <td>
            <p-button
              label="Contacts"
              icon="pi pi-table"
              severity="info"
              (click)="showContactDetails(contact.contactId)"
            />
          </td> -->
        </tr>
      </ng-template>

      <ng-template #emptyMessage>
        <tr>
          <td colspan="5">Contact not found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
