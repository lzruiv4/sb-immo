<div class="property-container">
  <div class="title-container">
    <button
      pButton
      label="New property"
      (click)="openCreateDialog = true"
    ></button>

    <app-create-property
      [visible]="openCreateDialog"
      (closeDialog)="openCreateDialog = false"
    ></app-create-property>
  </div>

  <p-table
    [value]="(properties$ | async) ?? []"
    dataKey="propertyId"
    [rows]="5"
    editMode="row"
    [rowsPerPageOptions]="[5, 10, 20, 50]"
    [loading]="loading"
    [paginator]="true"
    [globalFilterFields]="[
      'propertyName',
      'address',
      'unit',
      'area',
      'buildYear',
      'status'
    ]"
    [tableStyle]="{ width: '100%' }"
  >
    <ng-template #header>
      <tr>
        <th>Avatar</th>
        <th>
          <div class="flex items-center">
            Property name
            <p-columnFilter type="text" field="propertyName" display="menu" />
          </div>
        </th>
        <th>
          <div class="flex items-center">
            Street
            <p-columnFilter type="text" field="address.street" display="menu" />
          </div>
        </th>
        <th>
          <div class="flex items-center">House number</div>
        </th>
        <th>
          <div class="flex items-center">Post code</div>
        </th>
        <th>
          <div class="flex items-center">City</div>
        </th>
        <th>
          <div class="flex items-center">Unit</div>
        </th>
        <th>
          <div class="flex items-center">Area</div>
        </th>
        <th>
          <div class="flex items-center">Build year</div>
        </th>
        <th>Status</th>
        <th>Edit</th>
      </tr>
    </ng-template>
    <ng-template #body let-property let-editing="editing" let-ri="rowIndex">
      <tr [pEditableRow]="property">
        <td>
          <p-avatar icon="pi pi-home" class="mr-2" />
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                type="text"
                [(ngModel)]="property.propertyName"
                name="propertyName"
              />
            </ng-template>
            <ng-template #output>
              {{ property.propertyName }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <app-address-search
                [oldAddress]="property.address.street"
                [(ngModel)]="property.address.street"
                (addressSelected)="onAddressChosen($event, property)"
                name="street"
                style="min-width: 200px"
              />
            </ng-template>
            <ng-template #output>
              {{ property.address.street }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                type="text"
                [(ngModel)]="property.address.houseNumber"
                name="houseNumber"
              />
            </ng-template>
            <ng-template #output>
              {{ property.address.houseNumber }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                type="text"
                [(ngModel)]="property.address.postcode"
                name="postcode"
              />
            </ng-template>
            <ng-template #output>
              {{ property.address.postcode }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                type="text"
                [(ngModel)]="property.address.city"
                name="city"
              />
            </ng-template>
            <ng-template #output>
              {{ property.address.city }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                type="text"
                [(ngModel)]="property.unit"
                name="unit"
              />
            </ng-template>
            <ng-template #output>
              {{ property.unit }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                type="text"
                [(ngModel)]="property.area"
                name="area"
              />
            </ng-template>
            <ng-template #output>
              {{ property.area }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-cellEditor>
            <ng-template #input>
              <input
                pInputText
                type="text"
                [(ngModel)]="property.buildYear"
                name="buildYear"
              />
            </ng-template>
            <ng-template #output>
              {{ property.buildYear }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td>
          <p-tag
            [value]="getStatusTag(property.status).label"
            [severity]="getStatusTag(property.status).severity"
          />
        </td>
        <td>
          <div class="flex items-center justify-center gap-2">
            <button
              *ngIf="!editing"
              pButton
              pRipple
              type="button"
              pInitEditableRow
              icon="pi pi-pencil"
              (click)="onRowEditInit()"
              text
              rounded
              severity="secondary"
            ></button>
            <button
              *ngIf="editing"
              pButton
              pRipple
              type="button"
              pSaveEditableRow
              icon="pi pi-check"
              (click)="onRowEditSave(property)"
              text
              rounded
              severity="secondary"
            ></button>
            <button
              *ngIf="editing"
              pButton
              pRipple
              type="button"
              pCancelEditableRow
              icon="pi pi-times"
              (click)="onRowEditCancel()"
              text
              rounded
              severity="secondary"
            ></button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #emptyMessage>
      <tr>
        <td colspan="5">Property not found.</td>
      </tr>
    </ng-template>
  </p-table>
</div>
